#!/bin/sh

echo Configuring Shairport

rm -f config.mk config.h

echo "// automatically generated file" > config.h

LDFLAGS="${LDFLAGS} -lm -lpthread"

if make -f Makefile.tests test_getopt > /dev/null;  then
    echo "getopt.h found"
    echo "#define CONFIG_HAVE_GETOPT_H" >> config.h
    echo "CONFIG_HAVE_GETOPT_H=yes" >> config.mk
else
    echo "getopt.h not found (or compiler broken), using our own getopt_long."
fi

# check for and use pkg-config package $2 with CONFIG_ var $3
do_pkg_config()
{
    if pkg-config $2 2>/dev/null; then
        CFLAGS="${CFLAGS} `pkg-config --cflags $2`"
        LDFLAGS="${LDFLAGS} `pkg-config --libs $2`"
        if [ "$3" ]; then
            echo "#define $3" >> config.h
            echo "$3=yes" >> config.mk
        fi
        echo "$1 found"
    else
        echo "$1 or its dev package not found"
        if [ ! "$3" ]; then
            echo "Required package not found, cannot continue"
            rm -f config.mk config.h
            exit 1
        fi
    fi
}

do_export_variable()
{
    echo "$1=$(eval echo \$$1)" >> config.mk
    echo "#define $1 \"$(eval echo \$$1)\"" >> config.h
}

[ "${PREFIX}" ] || PREFIX=/usr/local
PLUGINS_PATH=${PREFIX}/lib/shairport/plugins
PLUGIN_EXT=.so

do_pkg_config OpenSSL       openssl
do_pkg_config libao         ao              CONFIG_AO
do_pkg_config PulseAudio    libpulse-simple CONFIG_PULSE
do_pkg_config ALSA          alsa            CONFIG_ALSA
do_pkg_config Avahi\ client avahi-client    CONFIG_AVAHI

do_export_variable PREFIX
do_export_variable PLUGINS_PATH
do_export_variable PLUGIN_EXT

echo "CFLAGS+=${CFLAGS}" >> config.mk
echo "LDFLAGS+=${LDFLAGS}" >> config.mk
echo "CONFIG_DYNAMIC_PLUGINS=yes" >> config.mk
echo "#define CONFIG_DYNAMIC_PLUGINS" >> config.h

echo CFLAGS: ${CFLAGS}
echo LDFLAGS: ${LDFLAGS}
echo PREFIX: ${PREFIX}

echo "Configure successful. You may now build with 'make'"
