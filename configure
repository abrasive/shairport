#!/bin/sh

[ -z "${CC}" ] && CC=cc

echo Configuring Shairport

rm -f config.mk config.h

echo "// automatically generated file" > config.h

LDFLAGS="${LDFLAGS} -lm -lpthread"

export_config()
{
    echo "#define $1" >> config.h
    echo "$1=yes" >> config.mk
    eval "$1=yes"
}

# check for header $1 with CONFIG_ var $2
check_header()
{
    echo "#include<$1>" > .header_test.c
    if ${CC} ${CFLAGS} ${LDFLAGS} -c .header_test.c > /dev/null 2>&1 /dev/null;  then
        echo "$1 found"
        if [ "$2" ]; then
            export_config $2
        fi
    else
        echo "$1 not found"
        if [ ! "$2" ]; then
            echo "Required header not found, cannot continue"
            rm .header_test.c
            rm -f config.mk config.h
            exit 1
        fi
    fi

    rm -f .header_test.c .header_test.o
}

# check for and use pkg-config package $2 with CONFIG_ var $3
do_pkg_config()
{
    if pkg-config $2 2>/dev/null; then
        CFLAGS="${CFLAGS} `pkg-config --cflags $2`"
        LDFLAGS="${LDFLAGS} `pkg-config --libs $2`"
        if [ "$3" ]; then
            export_config $3
        fi
        echo "$1 found"
    else
        echo "$1 or its dev package not found"
        if [ ! "$3" ]; then
            echo "Required package not found, cannot continue"
            rm -f config.mk config.h
            exit 1
        fi
    fi
}

#figure out which time function to use
check_time_function()
{
    cat >function_test.c <<FUNC_EOF
#include <time.h>

int main(int argc, char **argv){
    struct timespec *tsp;
    clock_gettime(CLOCK_MONOTONIC, tsp);
}
FUNC_EOF

    if ${CC} ${CFLAGS} ${LDFLAGS} -c function_test.c > /dev/null 2>&1 /dev/null; then
        echo "Found clock_gettime()"
        echo -n "Checking if rt lib switch should be added: "
        if ${CC} ${CFLAGS} ${LDFLAGS} function_test.c -lrt > /dev/null 2>&1 /dev/null; then
            echo "-lrt works, adding"
            LDFLAGS="${LDFLAGS} -lrt"
        else
            echo "-lrt not found, won't add"
        fi
    else
        echo "Checking if we can use mach time"
        check_header mach/mach.h
        check_header mach/clock.h
        export_config MACH_TIME
    fi
    rm -f function_test.*
}

# Check if command is installed
check_command()
{
if command -v $1 > /dev/null 2>&1; then
   echo $1 'is installed'
else
   echo $1 'is missing, cannot continue'
   exit 1
fi
}

# First check if the tools configure needs are installed
check_command pkg-config
check_command ${CC}

check_time_function

# On FreeBSD, OpenSSL is always there, but no .pc file is installed,
# so pkg-config does not report it
if [ `uname` = 'FreeBSD' ]; then
   echo "FreeBSD machine, assuming OpenSSL is there"
   LDFLAGS="${LDFLAGS} -lssl -lcrypto"
else
   do_pkg_config OpenSSL       openssl
fi
do_pkg_config libao         ao              CONFIG_AO
do_pkg_config PulseAudio    libpulse-simple CONFIG_PULSE
do_pkg_config ALSA          alsa            CONFIG_ALSA
do_pkg_config Avahi\ client avahi-client    CONFIG_AVAHI

if [ `uname` = 'OpenBSD' ]; then
    echo "OpenBSD machine, use sndio"
    export_config CONFIG_SNDIO
    LDFLAGS="${LDFLAGS} -lsndio"
fi

check_header  getopt.h      CONFIG_HAVE_GETOPT_H

# Don't build dns_sd backend if we have avahi
if [ -z "$CONFIG_AVAHI" ]; then
    check_header  dns_sd.h      CONFIG_HAVE_DNS_SD_H
fi


echo "CFLAGS+=${CFLAGS}" >> config.mk
echo "LDFLAGS+=${LDFLAGS}" >> config.mk

echo CFLAGS: ${CFLAGS}
echo LDFLAGS: ${LDFLAGS}

echo "Configure successful. You may now build with 'make'"
