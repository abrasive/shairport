#!/bin/sh

echo Configuring Shairport

rm -f config.mk config.h

echo "// automatically generated file" > config.h

LDFLAGS="${LDFLAGS} -lm -lpthread"

if make -f Makefile.tests test_getopt > /dev/null;  then
    echo "getopt.h found (or compiler broken)"
    echo "#define CONFIG_HAVE_GETOPT_H" >> config.h
    echo "CONFIG_HAVE_GETOPT_H=yes" >> config.mk
else
    echo "getopt.h not found, using our own getopt_long."
fi

if pkg-config openssl 2>/dev/null; then
    CFLAGS="${CFLAGS} `pkg-config --cflags openssl`"
    LDFLAGS="${LDFLAGS} `pkg-config --libs openssl`"
else
    echo OpenSSL or its dev package not found
fi

if pkg-config ao 2>/dev/null; then
    CFLAGS="${CFLAGS} `pkg-config --cflags ao`"
    LDFLAGS="${LDFLAGS} `pkg-config --libs ao`"
    echo "#define CONFIG_AO" >> config.h
    echo "CONFIG_AO=yes" >> config.mk
    echo libao found
else
    echo libao or its dev package not found
fi

if pkg-config libpulse-simple 2>/dev/null; then
    CFLAGS="${CFLAGS} `pkg-config --cflags libpulse-simple`"
    LDFLAGS="${LDFLAGS} `pkg-config --libs libpulse-simple`"
    echo "#define CONFIG_PULSE" >> config.h
    echo "CONFIG_PULSE=yes" >> config.mk
    echo libpulse found
else
    echo libpulse or its dev package not found
fi

if pkg-config avahi-client 2>/dev/null; then
    CFLAGS="${CFLAGS} `pkg-config --cflags avahi-client`"
    LDFLAGS="${LDFLAGS} `pkg-config --libs avahi-client`"
    echo "#define CONFIG_AVAHI" >> config.h
    echo "CONFIG_AVAHI=yes" >> config.mk
    echo avahi-client found
else
    echo avahi-client or its dev package not found
fi

echo "CFLAGS+=${CFLAGS}" >> config.mk
echo "LDFLAGS+=${LDFLAGS}" >> config.mk

echo CFLAGS: ${CFLAGS}
echo LDFLAGS: ${LDFLAGS}

echo Configure done
